<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Phân tích kế hoạch trả nợ vay</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    h1, h2 {
      color: #333;
    }
    form {
      background-color: #fff;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    form div {
      margin-bottom: 10px;
    }
    label {
      display: inline-block;
      width: 200px;
    }
    input[type="number"], select {
      width: 200px;
      padding: 5px;
    }
    button {
      padding: 8px 15px;
      background-color: #007BFF;
      color: #fff;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #interestRatesContainer div {
      margin-bottom: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: right;
    }
    th {
      background-color: #007BFF;
      color: #fff;
    }
    td:first-child, th:first-child {
      text-align: center;
    }
    #statistics {
      background-color: #fff;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #statistics p {
      font-size: 16px;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <h1>Phân tích kế hoạch trả nợ vay</h1>
  <form id="loanForm">
    <div>
      <label for="loanAmount">Số tiền vay (VND):</label>
      <input type="number" id="loanAmount" required>
    </div>
    <div>
      <label for="loanYears">Số năm vay (có thể số lẻ, VD: 1.5):</label>
      <input type="number" step="0.01" id="loanYears" required>
    </div>
    <div>
      <label for="calcMethod">Phương pháp tính:</label>
      <select id="calcMethod">
        <option value="annuity">Gốc, lãi chia đều hàng tháng (Annuity)</option>
        <option value="fixed">Gốc cố định, lãi giảm dần</option>
      </select>
    </div>
    <div>
      <button type="button" id="generateRates">Tạo lãi suất cho từng năm</button>
    </div>
    <div id="interestRatesContainer"></div>
    <div>
      <button type="button" id="calculateBtn">Tính toán</button>
    </div>
  </form>

  <div id="results">
    <h2>Lịch trả nợ</h2>
    <table id="scheduleTable">
      <thead>
        <tr>
          <th>Tháng</th>
          <th>Số dư đầu kỳ (VND)</th>
          <th>Tiền lãi (VND)</th>
          <th>Tiền gốc (VND)</th>
          <th>Tổng trả (VND)</th>
          <th>Số dư cuối kỳ (VND)</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <div id="statistics">
      <h2>Thống kê</h2>
      <p id="totalInterest">Tổng lãi phải trả: </p>
      <p id="totalPayment">Tổng số tiền gốc và lãi phải trả: </p>
    </div>
  </div>

  <script>
    // Hàm định dạng số theo tiền tệ (VD: 2700000000 → "2,700,000,000")
    function formatCurrency(value) {
      return value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // Tạo input cho lãi suất từng năm/phần năm
    document.getElementById('generateRates').addEventListener('click', function() {
      const loanYears = parseFloat(document.getElementById('loanYears').value);
      const container = document.getElementById('interestRatesContainer');
      container.innerHTML = ''; // Xóa nội dung cũ
      if (isNaN(loanYears) || loanYears <= 0) {
        alert('Vui lòng nhập số năm vay hợp lệ.');
        return;
      }
      const fullYears = Math.floor(loanYears);
      const hasFraction = (loanYears - fullYears) > 0.0001;
      const totalPeriods = fullYears + (hasFraction ? 1 : 0);
      const totalMonths = Math.round(loanYears * 12);

      for (let i = 1; i <= totalPeriods; i++) {
        let monthsInThisPeriod = (i < totalPeriods) ? 12 : (totalMonths - fullYears * 12);
        const div = document.createElement('div');
        if (i === totalPeriods && hasFraction) {
          div.innerHTML = '<label>Lãi suất cho ' + monthsInThisPeriod + ' tháng cuối (%): </label>' +
                          '<input type="number" step="0.01" id="rate-period-' + i + '" required>';
        } else {
          div.innerHTML = '<label>Lãi suất năm ' + i + ' (%): </label>' +
                          '<input type="number" step="0.01" id="rate-period-' + i + '" required>';
        }
        container.appendChild(div);
      }
    });

    // Sự kiện tính toán lịch trả nợ khi nhấn nút "Tính toán"
    document.getElementById('calculateBtn').addEventListener('click', function() {
      const loanAmount = parseFloat(document.getElementById('loanAmount').value);
      const loanYears = parseFloat(document.getElementById('loanYears').value);
      const calcMethod = document.getElementById('calcMethod').value;
      if (isNaN(loanAmount) || loanAmount <= 0) {
        alert('Vui lòng nhập số tiền vay hợp lệ.');
        return;
      }
      if (isNaN(loanYears) || loanYears <= 0) {
        alert('Vui lòng nhập số năm vay hợp lệ.');
        return;
      }
      // Xác định số tháng vay và số kỳ lãi suất
      const totalMonths = Math.round(loanYears * 12);
      const fullYears = Math.floor(loanYears);
      const hasFraction = (loanYears - fullYears) > 0.0001;
      const totalPeriods = fullYears + (hasFraction ? 1 : 0);

      // Lấy lãi suất cho từng kỳ
      let interestRates = [];
      for (let i = 1; i <= totalPeriods; i++) {
        const rateInput = document.getElementById('rate-period-' + i);
        if (!rateInput) {
          alert('Vui lòng tạo lãi suất theo từng năm/phần năm.');
          return;
        }
        const rate = parseFloat(rateInput.value);
        if (isNaN(rate) || rate < 0) {
          alert('Vui lòng nhập lãi suất hợp lệ cho kỳ ' + i);
          return;
        }
        interestRates.push(rate);
      }

      let schedule = [];
      if (calcMethod === 'annuity') {
        console.log(totalMonths);
        console.log(totalPeriods);
        schedule = computeScheduleAnnuity(loanAmount, totalMonths, interestRates, fullYears, hasFraction, totalPeriods);
      } else if (calcMethod === 'fixed') {
        schedule = computeScheduleFixed(loanAmount, totalMonths, interestRates, fullYears, hasFraction, totalPeriods);
      }

      // Hiển thị lịch trả nợ vào bảng
      const tbody = document.querySelector('#scheduleTable tbody');
      tbody.innerHTML = '';
      schedule.forEach(function(entry) {
        let row = document.createElement('tr');
        row.innerHTML = '<td>' + entry.month + '</td>' +
                        '<td>' + formatCurrency(entry.beginningBalance) + '</td>' +
                        '<td>' + formatCurrency(entry.interest) + '</td>' +
                        '<td>' + formatCurrency(entry.principal) + '</td>' +
                        '<td>' + formatCurrency(entry.payment) + '</td>' +
                        '<td>' + formatCurrency(entry.endingBalance) + '</td>';
        tbody.appendChild(row);
      });

      // Tính toán thống kê
      let totalInterest = schedule.reduce((sum, entry) => sum + entry.interest, 0);
      let totalPayment = schedule.reduce((sum, entry) => sum + entry.payment, 0);

      // Hiển thị thống kê
      document.getElementById('totalInterest').innerText = "Tổng lãi phải trả: " + formatCurrency(totalInterest) + " VND";
      document.getElementById('totalPayment').innerText = "Tổng số tiền gốc và lãi phải trả: " + formatCurrency(totalPayment) + " VND";
    });

    // Hàm tính lịch trả nợ theo phương pháp "Gốc, lãi chia đều hàng tháng" (Annuity)
    function computeScheduleAnnuity(loanAmount, totalMonths, interestRates, fullYears, hasFraction, totalPeriods) {
      let schedule = [];
      let remainingLoan = loanAmount;
      let currentMonth = 1;
      console.log(`totalPreriods: ${totalPeriods}`);
      console.log(`totalMonths: ${totalMonths}`);
      for (let period = 0; period < totalPeriods; period++) {
        console.log(`period: ${period}`);
        let monthsInPeriod = (period < totalPeriods - 1) ? 12 : (totalMonths - fullYears * 12);
        console.log(monthsInPeriod);
        let monthlyRate = interestRates[period] / 100 / 12;
        // Số tháng còn lại kể từ thời điểm hiện tại
        let monthsRemaining = totalMonths - (currentMonth - 1);
        let monthlyPayment;
        if (monthlyRate === 0) {
          monthlyPayment = remainingLoan / monthsRemaining;
        } else {
          monthlyPayment = remainingLoan * monthlyRate * Math.pow(1 + monthlyRate, monthsRemaining) /
                           (Math.pow(1 + monthlyRate, monthsRemaining) - 1);
        }
        for (let m = 0; m < monthsInPeriod; m++) {
          if (remainingLoan <= 0.01) { remainingLoan = 0; break; }
          let beginningBalance = remainingLoan;
          let interestPayment = beginningBalance * monthlyRate;
          let principalPayment = monthlyPayment - interestPayment;
          if (principalPayment > remainingLoan) {
            principalPayment = remainingLoan;
            monthlyPayment = interestPayment + principalPayment;
          }
          let endingBalance = beginningBalance - principalPayment;
          schedule.push({
            month: currentMonth,
            beginningBalance: beginningBalance,
            interest: interestPayment,
            principal: principalPayment,
            payment: monthlyPayment,
            endingBalance: endingBalance
          });
          remainingLoan = endingBalance;
          currentMonth++;
        }
      }
      console.log(`Số tháng: ${schedule.length}`);
      return schedule;
    }

    // Hàm tính lịch trả nợ theo phương pháp "Gốc cố định, lãi giảm dần"
    function computeScheduleFixed(loanAmount, totalMonths, interestRates, fullYears, hasFraction, totalPeriods) {
      let schedule = [];
      // Số gốc cố định mỗi tháng
      let fixedPrincipal = loanAmount / totalMonths;
      let remainingLoan = loanAmount;
      let currentMonth = 1;
      // Xây dựng mảng lãi suất hàng tháng dựa trên các kỳ đã nhập
      let monthRates = [];
      for (let period = 0; period < totalPeriods; period++) {
        let monthsInPeriod = (period < totalPeriods - 1) ? 12 : (totalMonths - fullYears * 12);
        let monthlyRate = interestRates[period] / 100 / 12;
        for (let m = 0; m < monthsInPeriod; m++) {
          monthRates.push(monthlyRate);
        }
      }
      for (let i = 0; i < totalMonths; i++) {
        let beginningBalance = remainingLoan;
        let monthlyRate = monthRates[i];
        let interestPayment = beginningBalance * monthlyRate;
        let principalPayment = fixedPrincipal;
        if (principalPayment > remainingLoan) {
          principalPayment = remainingLoan;
        }
        let monthlyPayment = interestPayment + principalPayment;
        let endingBalance = beginningBalance - principalPayment;
        schedule.push({
          month: currentMonth,
          beginningBalance: beginningBalance,
          interest: interestPayment,
          principal: principalPayment,
          payment: monthlyPayment,
          endingBalance: endingBalance
        });
        remainingLoan = endingBalance;
        currentMonth++;
      }
      return schedule;
    }
  </script>
</body>
</html>
